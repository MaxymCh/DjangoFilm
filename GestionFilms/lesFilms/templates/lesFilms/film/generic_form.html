{% extends "lesFilms/base.html" %} {% block title %}{{ action_name }} {{
class_name }}{% endblock %} {% block content %}
<form method="post" class="post-form">
  {% csrf_token %}
  <div class="container">
    <br />
    <div class="form-group row">
      <label class="col-sm-1 col-form-label"></label>
      <div class="col-sm-4">
        <h3>{{ action_description }} {{ class_name }}</h3>
      </div>
    </div>
    {{ form.as_p }}
    <a href="#" data-bs-toggle="modal"
          data-bs-target="#createActeurModal" class="open-createModal">Crée Acteur
    </a>
    <a href="#" data-bs-toggle="modal"
    data-bs-target="#createRealisateurModal" class="open-createModal">Crée Realisateur
    </a>

    <div class="form-group row">
      <label class="col-sm-1 col-form-label"></label>
      <div class="col-sm-4">
        <button type="submit" class="btn btn-success">Valider</button>
      </div>
    </div>
  </div>
</form>

<div
  class="modal fade"
  id="createRealisateurModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          Création de Realisteur
        </h5>
        <button type="button"  class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="input-realisateur-prenom">Prenom</label>
          <input type="text" class="form-control" id="input-realisateur-prenom">
        </div>
        <div class="form-group">
          <label for="input-realisateur-nom">Nom</label>
          <input type="text" class="form-control" id="input-realisateur-nom">
        </div>
      </div>
      <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal">Annuler
          </button>
          <button type="button" class="btn btn-success" id="btn-create-realisateur">Crée</button>
      </div>
    </div>
  </div>
</div>  

<div
  class="modal fade"
  id="createActeurModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
  aria-hidden="true"
>
<div class="modal-dialog">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="exampleModalLabel">
        Création d'acteur
      </h5>
      <button type="button"  class="btn-close"
        data-bs-dismiss="modal"
        aria-label="Close"
      ></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="input-realisateur-prenom">Prenom</label>
        <input type="text" class="form-control" id="input-acteur-prenom">
      </div>
      <div class="form-group">
        <label for="input-realisateur-nom">Nom</label>
        <input type="text" class="form-control" id="input-acteur-nom">
      </div>
    </div>
    <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal">Annuler
        </button>
        <button type="button" class="btn btn-success" id="btn-create-acteur">Crée</button>
    </div>
  </div>
</div>
{% if show_modal %}
  <div id="modalid"class="modal {% if not show_modal %}d-none{% endif %}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Les titres suivants sont similaires:</p>
                <ul>
                    {% for titre in form.titres_similaires %}
                    <li>{{ titre }}</li>
                    {% endfor %}
                </ul>
                <p>Êtes-vous sûr de vouloir créer ce film?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <a href="{% url 'film_add' %}" class="btn btn-primary">Confirmer la création</a>
            </div>
        </div>
    </div>
  </div>
{% endif %}


<script>
  document.addEventListener("DOMContentLoaded", function () {

    const modalCreateRealisateurSubmit = document.getElementById(
      "btn-create-realisateur"
    );
    modalCreateRealisateurSubmit.addEventListener("click", function (e) {
      e.preventDefault();
      const formData = new FormData();
      const realisateurInputNom = document.getElementById("input-realisateur-nom");
      const realisateurInputPrenom = document.getElementById("input-realisateur-prenom");
      if(realisateurInputNom.checkValidity() && realisateurInputPrenom.checkValidity())
      formData.append("nom", realisateurInputNom.value);
      formData.append("prenom", realisateurInputPrenom.value);
      fetch("{% url 'create_realisateur_in_film' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          const newOption = new Option(data.name, data.id, true, true);
          const acteursSelect = document.querySelector('select[name="realisateur"]');
          acteursSelect.append(newOption);
          realisateurInputNom.value ="";
          realisateurInputPrenom.value ="";
          $('#createRealisateurModal').modal('hide');
        });
    });


    const modalCreateActeurSubmit = document.getElementById(
      "btn-create-acteur"
    );
    modalCreateActeurSubmit.addEventListener("click", function (e) {
      e.preventDefault();
      const formData = new FormData();
      const acteurInputNom = document.getElementById("input-acteur-nom");
      const acteurInputPrenom = document.getElementById("input-acteur-prenom");
      if(acteurInputNom.checkValidity() && acteurInputPrenom.checkValidity())
      formData.append("nom", acteurInputNom.value);
      formData.append("prenom", acteurInputPrenom.value);
      fetch("{% url 'create_acteur_in_film' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          const newOption = new Option(data.name, data.id, true, true);
          const acteursSelect = document.querySelector('select[name="acteurs"]');
          acteursSelect.append(newOption);
          acteurInputNom.value ="";
          acteurInputPrenom.value ="";
          $('#createActeurModal').modal('hide');
        });
    });
  });

  function getCookie(name) {
    let value = "; " + document.cookie;
    let parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
  }
</script>
{% endblock %}
